DELIMITER ;;

CREATE PROCEDURE ProcUpdateUser_v1(
    IN storedUsername VARCHAR(64),
    IN storedEmail VARCHAR(256),
    IN storedPassword VARCHAR(512),
    IN valueUsername VARCHAR(64),
    IN valueFirstname VARCHAR(32),
    IN valueLastname VARCHAR(32),
    IN valueEmail VARCHAR(256),
    IN valuePassword VARCHAR(512),
    IN valueMembership VARCHAR(32),
    IN valueLanguage VARCHAR(32),
    IN valueVerify VARCHAR(32),
    IN valueTheme VARCHAR(32)
)
UpdateUser: 
BEGIN
    -- Eski Değerler İçin Değişkenler
    DECLARE old_firstname VARCHAR(32);
    DECLARE old_lastname VARCHAR(32);

    -- Değişken tanımlamaları
    DECLARE membership_id INT DEFAULT 1;
    DECLARE language_id INT DEFAULT 1;
    DECLARE verify_id INT DEFAULT 1;
    DECLARE theme_id INT DEFAULT 1;
    
    -- SHA 512 için şifreleme için değişken
    DECLARE stored_encrypted_password VARCHAR(128);
    DECLARE new_encrypted_password VARCHAR(128);
    
    -- Kullanıcı Varlığı İçin Değer Kontrolleri
    IF storedUsername IS NULL OR storedEmail IS NULL OR storedPassword IS NULL THEN
        SELECT 'Doğrulama İçin Kullanıcı Adı, E-posta Adresi veya Şifre Boş Olamaz!' AS message;
        LEAVE UpdateUser;
    END IF;
    
    -- Kullanıcı adı ve e-posta adresi var mı diye kontrol et, yoksa kullanıcı zaten güncellenemez
    SELECT COUNT(*) INTO @count_user FROM Users WHERE usersUsername = storedUsername AND usersEmail = storedEmail;
    	
    IF @count_user < 1 OR @count_user IS NULL THEN
        SELECT 'Kullanıcı Bulunamadı...' AS message;
        LEAVE UpdateUser;
    END IF;
    
    -- Geçici Olarak Oluşturulan Değişkenlere Kayıtlı Verileri Aktar
    SELECT usersFirstname, usersLastname, usersMemberid, usersLanguageid, usersVerifyid, usersThemeid
    INTO old_firstname, old_lastname, membership_id, language_id, verify_id, theme_id
    FROM Users
    WHERE usersUsername = storedUsername;
    
    -- Güncellenmek İstenen Değerler Yoksa Eskisine Ayarla
    SET valueUsername = IFNULL(valueUsername, storedUsername);
    SET valueEmail = IFNULL(valueEmail, storedEmail);
    SET valuePassword = IFNULL(valuePassword, storedPassword);
    SET valueFirstname = IFNULL(valueFirstname, old_firstname);
    SET valueLastname = IFNULL(valueLastname, old_lastname);
    
    -- SHA 512 ile depolanmış ve yeni kullanıcı şifresini şifrele
    SET stored_encrypted_password = SHA2(storedPassword, 512);
    SET new_encrypted_password = SHA2(valuePassword, 512);
    
    -- Üye ID değerini almak
    IF valueMembership IS NOT NULL THEN
        SELECT membershipId INTO membership_id FROM Membership WHERE membershipValue = valueMembership LIMIT 1;
        SET membership_id = IFNULL(membership_id, 1);
    END IF;
    
    -- Dil ID değerini almak
    IF valueLanguage IS NOT NULL THEN
        SELECT languagesId INTO language_id FROM Languages WHERE languagesValue = valueLanguage LIMIT 1;
        SET language_id = IFNULL(language_id, 1);
    END IF;
    
    -- Doğrulama ID değerini almak
    IF valueVerify IS NOT NULL THEN
        SELECT verifyId INTO verify_id FROM Verify WHERE verifyValue = valueVerify LIMIT 1;
        SET verify_id = IFNULL(verify_id, 1);
    END IF;
    
    -- Tema ID değerini almak
    IF valueTheme IS NOT NULL THEN
        SELECT themesId INTO theme_id FROM Themes WHERE themesValue = valueTheme LIMIT 1;
        SET theme_id = IFNULL(theme_id, 1);
    END IF;
    
    -- Kullanıcı Bilgilerini Güncellemek
    UPDATE Users SET usersUsername = valueUsername,
    	usersFirstname = valueFirstname,
    	usersLastname = valueLastname,
    	usersEmail = valueEmail,
    	usersPassword = new_encrypted_password,
    	usersMemberid = membership_id,
    	usersLanguageid = language_id,
    	usersVerifyid = verify_id,
    	usersThemeid = theme_id
    WHERE usersUsername = storedUsername AND
    	usersEmail = storedEmail AND
    	usersPassword = stored_encrypted_password;
    	
    -- İşlem yapılan satır sayısı varsa güncelleme başarılı, değilse başarısızdır
    IF ROW_COUNT() > 0 THEN
    	SELECT 'Kullanıcı Bilgileri Başarıyla Güncellendi :)' AS result;
    ELSE
    	SELECT 'Kullanıcı Bilgileri Güncellenemdi :(' AS result;
    END IF;
END ;;

DELIMITER ;
